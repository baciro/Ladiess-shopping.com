document.addEventListener('DOMContentLoaded', () => {
    const categories = document.querySelectorAll('.category');
    const subcategoriesSection = document.getElementById('subcategories');
    const productsSection = document.getElementById('products');
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const cartItems = document.getElementById('cart-items');
    const checkoutBtn = document.getElementById('checkout-btn');
    const backBtn = document.getElementById('back-btn');
    const cartIndicator = document.getElementById('cart-indicator');

    // Função para salvar o carrinho no localStorage
    function saveCartToLocalStorage() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Evento para voltar atrás
    backBtn.addEventListener('click', () => {
        window.history.back();
    });

    if (categories.length > 0) {
        categories.forEach(category => {
            category.addEventListener('click', (e) => {
                const category = e.target.getAttribute('data-category');
                window.location.href = `categories.html?category=${category}`;
            });
        });
    }

    if (subcategoriesSection) {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const subcategoryTitle = document.getElementById('category-title');
        subcategoryTitle.innerText = `Subcategorias de ${category}`;

        const subcategories = {
            sapatos: ['zara', 'hermes'],
            cabelos: ['cacheados', 'lisos', 'ondolado'],
            bolsas: ['prada', 'gucci']
        };

        subcategories[category].forEach(sub => {
            const subcategoryDiv = document.createElement('div');
            subcategoryDiv.classList.add('subcategory');
            subcategoryDiv.setAttribute('data-subcategory', sub);
            subcategoryDiv.innerText = sub.charAt(0).toUpperCase() + sub.slice(1);
            subcategoryDiv.addEventListener('click', (e) => {
                const subcategory = e.target.getAttribute('data-subcategory');
                window.location.href = `products.html?category=${category}&subcategory=${subcategory}`;
            });
            subcategoriesSection.appendChild(subcategoryDiv);
        });
    }

    if (productsSection) {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const subcategory = urlParams.get('subcategory');
        const subcategoryTitle = document.getElementById('subcategory-title');
        subcategoryTitle.innerText = `Produtos de ${subcategory}`;

        const products = [
            { name: 'Sapato Zara 1', price: '20.000', image: 'images/sapatos/Zara/IMG-20240618-WA0049.jpg', category: 'sapatos', subcategory: 'zara' },
            { name: 'Sapato Zara 2', price: '25.000', image: 'images/sapatos/Zara/IMG-20240618-WA0076.jpg', category: 'sapatos', subcategory: 'zara' },
            // Adicione todos os seus produtos aqui
        ];

        const filteredProducts = products.filter(product => product.category === category && product.subcategory === subcategory);

        filteredProducts.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.classList.add('product');
            productDiv.setAttribute('data-name', product.name);
            productDiv.setAttribute('data-price', product.price);
            productDiv.setAttribute('data-image', product.image);
            productDiv.innerHTML = `
                <img src="${product.image}" alt="${product.name}">
                <h2>${product.name}</h2>
                <p>Preço: ${product.price}F cfa</p>
                <button class="buy-btn">Comprar</button>
            `;
            productsSection.appendChild(productDiv);
        });

        const buyButtons = document.querySelectorAll('.buy-btn');
        buyButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const product = e.target.parentElement;
                const name = product.getAttribute('data-name');
                const price = product.getAttribute('data-price');
                const image = product.getAttribute('data-image');
                addToCart({ name, price, image });
                renderCart();
            });
        });
    }

    function addToCart(product) {
        cart.push(product);
        saveCartToLocalStorage(); // Salva o carrinho no localStorage após adicionar um produto
        renderCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        saveCartToLocalStorage(); // Salva o carrinho no localStorage após remover um produto
        renderCart();
    }

    function renderCart() {
        cartItems.innerHTML = '';
        cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <img src="${item.image}" alt="${item.name}">
                <div>
                    <p>${item.name} - ${item.price}F cfa</p>
                    <button class="remove-btn" data-index="${index}">Remover</button>
                </div>
            `;
            cartItems.appendChild(li);
        });

        const removeButtons = document.querySelectorAll('.remove-btn');
        removeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const index = e.target.getAttribute('data-index');
                removeFromCart(index);
            });
        });

        // Atualiza o indicador visual do carrinho
        if (cart.length > 0) {
            cartIndicator.innerHTML = '<span>&#9660;</span>'; // Exemplo de seta para baixo
        } else {
            cartIndicator.innerHTML = ''; // Limpa o indicador se o carrinho estiver vazio
        }
    }

    checkoutBtn.addEventListener('click', () => {
        if (cart.length > 0) {
            let message = 'Gostaria de finalizar a compra dos seguintes itens:\n\n';
            cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name} - ${item.price}F cfa\n${item.image}\n`;
            });
            const whatsappUrl = `https://wa.me/221778034451?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        } else {
            alert('Seu carrinho está vazio!');
        }
    });

    // Renderiza o carrinho ao carregar a página
    renderCart();
});
